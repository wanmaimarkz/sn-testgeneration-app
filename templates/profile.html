{% extends 'layout.html' %}
{% block title %}
  Profile Management
{% endblock %}

{% block content %}
  <div class="flex items-center justify-center h-full overflow-y-auto py-8">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-lg overflow-hidden my-auto">
      <div class="bg-linear-to-r from-blue-600 to-purple-600 p-8 text-center">
        <div class="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-white/30">
          <i class="fas fa-user-edit text-3xl"></i>
        </div>
        <h1 class="text-2xl font-bold">Profile Settings</h1>
      </div>

      <form action="{{ url_for('update_profile') }}" method="POST" class="p-8 space-y-5" id="profileForm">
        <div class="grid grid-cols-2 gap-4">
          <div class="space-y-1">
            <label class="text-xs font-bold text-gray-500 uppercase ml-1">First name</label>
            <input type="text" name="first_name" value="{{ current_user.first_name }}" required class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-bold text-gray-500 uppercase ml-1">Last name</label>
            <input type="text" name="last_name" value="{{ current_user.last_name }}" required class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all" />
          </div>
        </div>

        <div class="space-y-1">
          <label class="text-xs font-bold text-gray-500 uppercase ml-1">Email</label>
          <input type="email" value="{{ current_user.email }}" disabled class="w-full px-4 py-3 bg-gray-100 border border-gray-200 rounded-xl text-gray-400 cursor-not-allowed" />
        </div>

        <hr class="border-gray-100 my-2" />
        <div class="space-y-1 text-blue-600 font-bold flex items-center gap-2 text-lg">
          <i class="fas fa-shield-alt"></i> Change Password (Leave it blank if you're not going to change it.)
        </div>
        <div class="space-y-1">
          <label class="text-xs font-bold text-gray-500 uppercase ml-1">New Password</label>
          <input type="password" name="new_password" id="new_password" placeholder="••••••••" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all" />
        </div>

        <div class="space-y-1">
          <label class="text-xs font-bold text-gray-500 uppercase ml-1 font-error">Confirm Password</label>
          <input type="password" name="confirm_password" id="confirm_password" placeholder="••••••••" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all" />
          {% with messages=get_flashed_messages(with_categories=true) %}
            {% for category, message in messages %}
              {% if category == 'error-confirm' %}
                <p class="text-xs text-red-500 mt-1 ml-1 animate-pulse">
                  <i class="fas fa-times-circle"></i> {{ message }}
                </p>
              {% endif %}
            {% endfor %}
          {% endwith %}
          <p id="js-password-error" class="hidden text-xs text-red-500 mt-1 ml-1">
            <i class="fas fa-times-circle"></i> password not matching.
          </p>
        </div>

        <hr class="border-gray-100" />

        <label class="text-sm font-bold text-red-700 uppercase ml-1 flex items-center gap-2"><i class="fas fa-lock"></i> Current password (for identity verification)</label>
        <input type="password" name="current_password" required placeholder="Enter your current password" class="w-full px-4 py-3 bg-white border border-amber-200 rounded-xl focus:ring-2 focus:ring-amber-500 outline-none transition-all" />
        {% with messages=get_flashed_messages(with_categories=true) %}
          {% for category, message in messages %}
            {% if category == 'error-current' %}
              <p class="text-xs text-red-600 mt-1 ml-1 font-bold animate-bounce">
                <i class="fas fa-exclamation-circle"></i> {{ message }}
              </p>
            {% endif %}
          {% endfor %}
        {% endwith %}

        <button type="submit" class="w-full py-4 bg-blue-600 text-white rounded-xl font-bold text-lg hover:bg-blue-700 hover:shadow-lg transition-all transform active:scale-[0.98]">Save change</button>
      </form>
    </div>
  </div>

  <script>
    // Client-side validation: เช็ค Password ตรงกันก่อนส่งฟอร์ม
    const form = document.getElementById('profileForm')
    const newPass = document.getElementById('new_password')
    const confirmPass = document.getElementById('confirm_password')
    const errorMsg = document.getElementById('js-password-error')
    
    form.addEventListener('submit', function (e) {
      if (newPass.value !== confirmPass.value) {
        e.preventDefault()
        errorMsg.classList.remove('hidden')
        confirmPass.classList.add('border-red-500', 'ring-1', 'ring-red-500')
      }
    })
    
    // ล้าง Error เมื่อกลับมาพิมพ์ใหม่
    confirmPass.addEventListener('input', () => {
      errorMsg.classList.add('hidden')
      confirmPass.classList.remove('border-red-500', 'ring-1', 'ring-red-500')
    })

    setTimeout(() => {
    const successAlert = document.querySelector('.bg-green-50');
    if (successAlert) successAlert.style.display = 'none';
    }, 5000);
  </script>
{% endblock %}
